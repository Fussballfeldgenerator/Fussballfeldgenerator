<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Franks Fußballfeld-Generator</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  html,body,#map{height:100%;margin:0}
  .ctrl{
    position:fixed;top:8px;left:50%;transform:translateX(-50%);
    background:#fff;padding:.35rem .45rem;border-radius:.5rem;
    box-shadow:0 2px 10px rgba(0,0,0,.16);z-index:1000;
    display:flex;gap:.35rem;align-items:center;flex-wrap:wrap;font-size:.84rem
  }
  button,select,input,label{
    padding:.28rem .42rem;border:1px solid #d1d5db;border-radius:.4rem;background:#fff;cursor:pointer;
    font-size:.84rem;line-height:1.1
  }
  label{display:flex;gap:.35rem;align-items:center;border:none;padding:0;background:transparent}
  .primary{background:#0ea5e9;border-color:#0284c7;color:#fff}
  .hint{
    position:fixed;bottom:8px;left:50%;transform:translateX(-50%);
    background:#111827;color:#fff;padding:.28rem .45rem;border-radius:.4rem;z-index:1000;font-size:.8rem;opacity:.9
  }
  input[type=number]{width:5.8rem}
  input[type=text]{width:13rem}
  @media (max-width:480px){ .ctrl{font-size:.8rem} button,select,input{font-size:.8rem} input[type=text]{width:11rem} }
</style>
</head>
<body>
<div id="map"></div>

<div class="ctrl">
  <button id="loc" class="primary">Standort</button>
  <button id="wms">Orthofoto</button>

  <select id="mode" title="Modus">
    <option value="grossfeld" selected>Großfeld</option>
    <option value="kleinfeld_im_grossfeld">+ Kleinfeld</option>
    <option value="kleinfeld">Kleinfeld (separat)</option>
  </select>

  <!-- Kleinfeld: nur die gewünschten Szenarien -->
  <select id="kfScenario" title="Kleinfeld-Szenario" disabled>
    <option value="">Szenario wählen…</option>
    <option value="g2v2_16x20">G-Jugend 2v2 – 16×20 m (Mittellinie, 4 Minitore)</option>
    <option value="g3v3_25x20">G-Jugend 3v3 – 25×20 m (Schusszonen, 4 Minitore)</option>
    <option value="f3v3_25x20">F-Jugend 3v3 – 25×20 m (Schusszonen, 4 Minitore)</option>
    <option value="g5v5_40x25">G-Jugend 5v5 – 40×25 m (wahlweise Minitore oder 5-m-Tore)</option>
    <option value="e7v7_55x35">E-Jugend 7v7 – 55×35 m (Mittellinie, 5-m-Tore + Strafraum)</option>
  </select>

  <!-- Nur bei G 5v5 sichtbar -->
  <select id="g5v5GoalType" title="G-5v5 Torart" style="display:none">
    <option value="mini4" selected>4 Minitore (2 m)</option>
    <option value="kf2">2 Kleinfeldtore (5 m)</option>
  </select>

  <label>L (m): <input id="length" type="number" step="1" min="1" value=""></label>
  <label>B (m): <input id="width"  type="number" step="0.1" value="65"></label>

  <label>Filename: <input id="fname" type="text" value="X-Platz_SVU"></label>
  <button id="reset">Neu</button>
  <button id="geojson">Export</button>
</div>

<div class="hint">Zwei Punkte der rechten Längsseite: 1 = Start (unten rechts), 2 = Richtung (oben rechts).</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/proj4@2.10.0/dist/proj4.js"></script>
<script>
/* ---- EPSG:25832 ---- */
proj4.defs("EPSG:25832","+proj=utm +zone=32 +datum=WGS84 +units=m +no_defs +type=crs");
const toUTM=(lat,lon)=>{const r=proj4("WGS84","EPSG:25832",[lon,lat]);return{x:r[0],y:r[1]}};
const toLL =(x,y)=>{const r=proj4("EPSG:25832","WGS84",[x,y]);return{lat:r[1],lon:r[0]}};

/* ---- Karte ---- */
const map=L.map('map').setView([48.1372,11.5756],18);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20,attribution:'© OpenStreetMap-Mitwirkende'}).addTo(map);

let dop=null; // DOP20 WMS (transparent, 1.1.1)
document.getElementById('wms').onclick=()=>{
  const btn=document.getElementById('wms');
  if(dop){map.removeLayer(dop);dop=null;btn.textContent="Orthofoto";return;}
  dop=L.tileLayer.wms('https://geoservices.bayern.de/od/wms/dop/v1/dop20?',{
    layers:'by_dop20c',version:'1.1.1',format:'image/png',transparent:true,uppercase:true,tileSize:256,
    attribution:'© LDBV DOP20 (WMS) CC BY 4.0'
  }).addTo(map);
  let err=0; dop.on('tileerror',()=>{ if(++err===3){ map.removeLayer(dop); dop=null; alert('Orthofoto WMS nicht erreichbar/zu hoher Zoom – bleibe bei OSM.'); btn.textContent="Orthofoto"; }});
  btn.textContent="Orthofoto aus";
};

/* ---- Standort ---- */
document.getElementById('loc').onclick=()=>{
  if(!navigator.geolocation){alert('Geolocation nicht verfügbar');return;}
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude,longitude,accuracy}=pos.coords;
    const z=accuracy<10?20:accuracy<25?19:18;
    map.setView([latitude,longitude],z);
    L.circle([latitude,longitude],{radius:accuracy}).addTo(draw);
  },()=>alert('Standort nicht möglich. Bitte HTTPS + Erlaubnis prüfen.'),{enableHighAccuracy:true,timeout:10000,maximumAge:0});
};

/* ---- Zeichenlayer ---- */
const draw=L.featureGroup().addTo(map);
const handles=L.featureGroup().addTo(map);
const clicks=L.featureGroup().addTo(map);
let p1=null,p2=null,lastResult=null;

/* ---- UI-Refs ---- */
const widthInput=document.getElementById('width');
const modeSel=document.getElementById('mode');
const fnameInput=document.getElementById('fname');
const lengthInput=document.getElementById('length');
const kfScenario=document.getElementById('kfScenario');
const g5v5GoalType=document.getElementById('g5v5GoalType');

modeSel.addEventListener('change',()=>{
  const isKF = modeSel.value==='kleinfeld';
  kfScenario.disabled = !isKF;
  g5v5GoalType.style.display = (isKF && kfScenario.value==='g5v5_40x25') ? '' : 'none';
  if (!isKF) { lengthInput.disabled=false; widthInput.disabled=false; }
  if (p1&&p2) recompute();
});
kfScenario.addEventListener('change',()=>{
  applyScenarioDimensions();
  g5v5GoalType.style.display = (kfScenario.value==='g5v5_40x25') ? '' : 'none';
  if (p1&&p2) recompute();
});
g5v5GoalType.addEventListener('change',()=>{ if(p1&&p2) recompute(); });

function applyScenarioDimensions(){
  const v=kfScenario.value;
  let L=null,W=null;
  if(v==='g2v2_16x20'){ L=16; W=20; }
  else if(v==='g3v3_25x20' || v==='f3v3_25x20'){ L=25; W=20; }
  else if(v==='g5v5_40x25'){ L=40; W=25; }
  else if(v==='e7v7_55x35'){ L=55; W=35; }
  if(L&&W){
    lengthInput.value=String(L);
    widthInput.value =String(W);
    lengthInput.disabled=true; // fix
    widthInput.disabled =true; // fix
  }else{
    lengthInput.disabled=false;
    widthInput.disabled=false;
  }
}

/* ---- Helpers ---- */
const norm=(dx,dy)=>{const L=Math.hypot(dx,dy)||1;return{ux:dx/L,uy:dy/L,L}};
const mid =(A,B)=>({x:(A.x+B.x)/2,y:(A.y+B.y)/2});
const toLLArr=ps=>ps.map(p=>{const g=toLL(p.x,p.y);return[g.lat,g.lon]});
function addLine(pA,pB,name,out){const gA=toLL(pA.x,pA.y),gB=toLL(pB.x,pB.y);L.polyline([[gA.lat,gA.lon],[gB.lat,gB.lon]]).addTo(draw).bindTooltip(name);out.lines.push({name,len:Math.hypot(pB.x-pA.x,pB.y-pA.y),p1:pA,p2:pB});}
function addPt(p,name,out){const g=toLL(p.x,p.y);L.circleMarker([g.lat,g.lon],{radius:4}).addTo(draw).bindTooltip(name);out.points.push({name,x:p.x,y:p.y});}
function addPoly(points,name,out){L.polyline(toLLArr(points)).addTo(draw).bindTooltip(name);let len=0;for(let i=1;i<points.length;i++){const a=points[i-1],b=points[i];len+=Math.hypot(b.x-a.x,b.y-a.y);}out.lines.push({name,len,points});}
function circle(c,r,seg=96){const pts=[];for(let i=0;i<=seg;i++){const a=2*Math.PI*i/seg;pts.push({x:c.x+r*Math.cos(a),y:c.y+r*Math.sin(a)});}return pts;}
function lineIntersection(a1,a2,b1,b2){
  const x1=a1.x,y1=a1.y,x2=a2.x,y2=a2.y,x3=b1.x,y3=b1.y,x4=b2.x,y4=b2.y;
  const den=(x1-x2)*(y3-y4)-(y1-y2)*(x3-x4); if(Math.abs(den)<1e-9)return null;
  const px=((x1*y2-y1*x2)*(x3-x4)-(x1-x2)*(x3*y4-y3*x4))/den;
  const py=((x1*y2-y1*x2)*(y3-y4)-(y1-y2)*(x3*y4-y3*x4))/den;
  return {x:px,y:py};
}

/* ---- Großfeld (Hauptmodus) – unverändert, mit Mittelkreis etc. ---- */
function drawTorbereich(mitte,ux,uy,nx,ny,prefix,out){
  const torHalb=7.32/2;
  const tor_r={x:mitte.x+nx*torHalb,y:mitte.y+ny*torHalb};
  const tor_l={x:mitte.x-nx*torHalb,y:mitte.y-ny*torHalb};
  addPt(mitte,`Torlinienmittelpunkt ${prefix}`,out);
  addPt(tor_r,`Torpfosten ${prefix} rechts`,out);
  addPt(tor_l,`Torpfosten ${prefix} links`,out);
  addLine(tor_r,tor_l,`Torlinie ${prefix}`,out);
  const f5r={x:tor_r.x+nx*5.5,y:tor_r.y+ny*5.5}, f5l={x:tor_l.x-nx*5.5,y:tor_l.y-ny*5.5};
  const e5r={x:f5r.x+ux*5.5,y:f5r.y+uy*5.5},     e5l={x:f5l.x+ux*5.5,y:f5l.y+uy*5.5};
  addLine(f5r,e5r,`5m Linie ${prefix} rechts`,out); addLine(f5l,e5l,`5m Linie ${prefix} links`,out); addLine(e5r,e5l,`5m Parallel ${prefix}`,out);
  const f16r={x:tor_r.x+nx*16.5,y:tor_r.y+ny*16.5}, f16l={x:tor_l.x-nx*16.5,y:tor_l.y-ny*16.5};
  const e16r={x:f16r.x+ux*16.5,y:f16r.y+uy*16.5},   e16l={x:f16l.x+ux*16.5,y:f16l.y+uy*16.5};
  addLine(f16r,e16r,`16m Linie ${prefix} rechts`,out); addLine(f16l,e16l,`16m Linie ${prefix} links`,out); addLine(e16r,e16l,`16m Parallel ${prefix}`,out);
  const elfer={x:mitte.x+ux*11,y:mitte.y+uy*11}; addPt(elfer,`Elfmeterpunkt ${prefix}`,out);
}

/* ---- Kleinfeld: Mini-Tore (2 m) an einer Grundlinie ---- */
function drawMiniGoalsOnEnd(endLeft, endRight, namePrefix, out){
  const ex=endRight.x-endLeft.x, ey=endRight.y-endLeft.y;
  const elen=Math.hypot(ex,ey)||1, vx=ex/elen, vy=ey/elen; // entlang Grundlinie
  // Links-nah
  const L_ref={x:endLeft.x+vx*2, y:endLeft.y+vy*2};
  const L_other={x:L_ref.x+vx*2, y:L_ref.y+vy*2};
  addPt(L_ref,`${namePrefix} Minitor-Pfosten (links, 2m von Seitenlinie)`,out);
  addLine(L_ref,L_other,`${namePrefix} Minitor (links, 2m)`,out);
  // Rechts-nah
  const R_ref={x:endRight.x-vx*2, y:endRight.y-vy*2};
  const R_other={x:R_ref.x-vx*2, y:R_ref.y-vy*2};
  addPt(R_ref,`${namePrefix} Minitor-Pfosten (rechts, 2m von Seitenlinie)`,out);
  addLine(R_ref,R_other,`${namePrefix} Minitor (rechts, 2m)`,out);
}

/* ---- Kleinfeld: 5-m-Tor über Mittelpunkt + ±2,5 m Pfosten ---- */
function drawKleinfeldGoalOnEnd(endLeft, endRight, namePrefix, out){
  const ex=endRight.x-endLeft.x, ey=endRight.y-endLeft.y;
  const elen=Math.hypot(ex,ey)||1, vx=ex/elen, vy=ey/elen; // entlang Grundlinie
  const mid={x:(endLeft.x+endRight.x)/2, y:(endLeft.y+endRight.y)/2};
  addPt(mid,`${namePrefix} Tor-Mittelpunkt`,out);
  const pR={x:mid.x+vx*2.5, y:mid.y+vy*2.5};
  const pL={x:mid.x-vx*2.5, y:mid.y-vy*2.5};
  addPt(pR,`${namePrefix} Torpfosten rechts (±2.5m)`,out);
  addPt(pL,`${namePrefix} Torpfosten links (±2.5m)`,out);
  addLine(pL,pR,`${namePrefix} Torlinie (5m)`,out);
}

/* ---- E-Jugend 7v7: Strafraum inkl. Linien ---- */
function markE7v7End(endLeft, endRight, intoFieldDir, namePrefix, out){
  // Richtung entlang der Torlinie
  const ex=endRight.x-endLeft.x, ey=endRight.y-endLeft.y;
  const elen=Math.hypot(ex,ey)||1, vx=ex/elen, vy=ey/elen;

  // Tor-Mittelpunkt + Pfosten (±2.5 m)
  const mid={x:(endLeft.x+endRight.x)/2, y:(endLeft.y+endRight.y)/2};
  addPt(mid,`${namePrefix} Tor-Mittelpunkt`,out);
  const pR={x:mid.x+vx*2.5, y:mid.y+vy*2.5};
  const pL={x:mid.x-vx*2.5, y:mid.y-vy*2.5};
  addPt(pR,`${namePrefix} Torpfosten rechts (±2.5m)`,out);
  addPt(pL,`${namePrefix} Torpfosten links (±2.5m)`,out);
  addLine(pL,pR,`${namePrefix} Torlinie (5m)`,out);

  // Fusspunkte Strafraum: von Pfosten je 12 m entlang der Torlinie "nach außen"
  const fL={x:pL.x - vx*12, y:pL.y - vy*12}; // links weiter nach links
  const fR={x:pR.x + vx*12, y:pR.y + vy*12}; // rechts weiter nach rechts
  addPt(fL,`${namePrefix} Fusspunkt Strafraum links (+12m)`,out);
  addPt(fR,`${namePrefix} Fusspunkt Strafraum rechts (+12m)`,out);

  // Eckpunkte Strafraum: von Fusspunkten 12 m orthogonal ins Feld
  const ix=intoFieldDir.x, iy=intoFieldDir.y; // normiert (ins Feld)
  const cL={x:fL.x + ix*12, y:fL.y + iy*12};
  const cR={x:fR.x + ix*12, y:fR.y + iy*12};
  addPt(cL,`${namePrefix} Ecke Strafraum links (12m orth.)`,out);
  addPt(cR,`${namePrefix} Ecke Strafraum rechts (12m orth.)`,out);

  // Strafstoßpunkt: vom Tor-Mittelpunkt 8 m ins Feld
  const sp={x:mid.x + ix*8, y:mid.y + iy*8};
  addPt(sp,`${namePrefix} Strafstoßpunkt (8m)`,out);

  // --- Strafraum-LINIEN ---
  addLine(fL, cL, `${namePrefix} Strafraum Linie links (12m orth.)`, out);
  addLine(fR, cR, `${namePrefix} Strafraum Linie rechts (12m orth.)`, out);
  addLine(cL, cR, `${namePrefix} Strafraum Vorderkante`, out);

  // Rückgabe für evtl. weitere Nutzung
  return {mid,pL,pR,fL,fR,cL,cR,sp};
}

/* ---- Schusszonen: 6 m von jeder Torlinie ins Feld ---- */
function drawSchusszonen(UL,UR,OL,OR, ux,uy, namePrefix, out){
  const bottomA={x:UL.x+ux*6, y:UL.y+uy*6};
  const bottomB={x:UR.x+ux*6, y:UR.y+uy*6};
  const topA   ={x:OL.x-ux*6, y:OL.y-uy*6};
  const topB   ={x:OR.x-ux*6, y:OR.y-uy*6};
  addLine(bottomA,bottomB,`${namePrefix} Schusszone unten (6m)`,out);
  addLine(topA,topB,      `${namePrefix} Schusszone oben (6m)`,out);
}

/* ---- Klick-Logik: 2 Punkte = Start + Richtung ---- */
map.on('click',e=>{
  if(handles.getLayers().length===2) return;
  clicks.addLayer(L.circleMarker(e.latlng,{radius:5}));
  if(!p1){ p1=e.latlng; }
  else{
    p2=e.latlng; makeHandles();
    const P1=toUTM(p1.lat,p1.lng), P2=toUTM(p2.lat,p2.lng);
    const Lm=Math.hypot(P2.x-P1.x,P2.y-P1.y);
    if (modeSel.value==='kleinfeld' && kfScenario.value){
      applyScenarioDimensions(); // fixiert L/B
    } else {
      lengthInput.value=String(Math.round(Lm));
      lengthInput.disabled=false; widthInput.disabled=false;
    }
    recompute();
  }
});
function makeHandles(){
  handles.clearLayers();
  const m1=L.marker(p1,{draggable:true,title:"Punkt 1 (Start, unten rechts)"}).addTo(handles);
  const m2=L.marker(p2,{draggable:true,title:"Punkt 2 (Richtung, oben rechts)"}).addTo(handles);
  m1.on('drag',()=>{p1=m1.getLatLng();recompute()});
  m2.on('drag',()=>{p2=m2.getLatLng();recompute()});
}

/* ---- Zeichnen ---- */
function recompute(){
  if(!p1||!p2) return;
  draw.clearLayers();

  const P1=toUTM(p1.lat,p1.lng), P2=toUTM(p2.lat,p2.lng);
  const {ux,uy}=norm(P2.x-P1.x,P2.y-P1.y);
  const len=Math.max(1,Math.round(parseFloat(lengthInput.value||"0")||0));
  const nx=-uy, ny=ux;
  const W=parseFloat(widthInput.value||"65");
  const mode=modeSel.value;

  // Außenrechteck aus Start+Richtung+Maßen
  const UR={x:P1.x,y:P1.y};                         // unten rechts (Start)
  const OR={x:P1.x+ux*len,y:P1.y+uy*len};           // oben rechts
  const OL={x:OR.x+nx*W,y:OR.y+ny*W};
  const UL={x:UR.x+nx*W,y:UR.y+ny*W};

  const out={points:[],lines:[]};

  /* --- Kleinfeld separat (Szenarien) --- */
  if(mode==='kleinfeld' && kfScenario.value){
    // Außen
    addLine(UL,UR,"(KF) Grundlinie unten",out);
    addLine(UR,OR,"(KF) Seitenlinie rechts",out);
    addLine(OR,OL,"(KF) Grundlinie oben",out);
    addLine(OL,UL,"(KF) Seitenlinie links",out);
    addPt(UL,"(KF) Eckpunkt unten links",out);
    addPt(UR,"(KF) Eckpunkt unten rechts",out);
    addPt(OL,"(KF) Eckpunkt oben links",out);
    addPt(OR,"(KF) Eckpunkt oben rechts",out);

    const scenario=kfScenario.value;

    // Mittellinie (wo gefordert) – immer mit Mittelpunkt
    const ml=mid(UL,OL), mr=mid(UR,OR);
    const midlineCenter={x:(ml.x+mr.x)/2, y:(ml.y+mr.y)/2};
    const needMidline = (
      scenario==='g2v2_16x20' ||
      (scenario==='g5v5_40x25' && g5v5GoalType.value==='kf2') ||
      scenario==='e7v7_55x35'
    );
    if(needMidline){
      addLine(ml,mr,"(KF) Mittellinie",out);
      addPt(midlineCenter,"(KF) Mittellinie Mittelpunkt",out);
    }

    // Schusszonen 6 m (wo gefordert)
    const needZones = (scenario==='g3v3_25x20' || scenario==='f3v3_25x20' ||
                      (scenario==='g5v5_40x25' && g5v5GoalType.value==='mini4'));
    if(needZones){
      drawSchusszonen(UL,UR,OL,OR, ux,uy, "(KF)", out);
    }

    // Tore / Markierungen je Szenario
    if(scenario==='g2v2_16x20' || scenario==='g3v3_25x20' || scenario==='f3v3_25x20'){
      drawMiniGoalsOnEnd(UL,UR,"(KF) unten",out);
      drawMiniGoalsOnEnd(OL,OR,"(KF) oben",out);
    } else if(scenario==='g5v5_40x25'){
      if(g5v5GoalType.value==='mini4'){
        drawMiniGoalsOnEnd(UL,UR,"(KF) unten",out);
        drawMiniGoalsOnEnd(OL,OR,"(KF) oben",out);
      }else{
        drawKleinfeldGoalOnEnd(UL,UR,"(KF) unten",out);
        drawKleinfeldGoalOnEnd(OL,OR,"(KF) oben",out);
      }
    } else if(scenario==='e7v7_55x35'){
      // E-Jugend 7v7: Strafraum komplett inkl. Linien
      markE7v7End(UL,UR,{x:ux,y:uy},"(KF) unten",out);   // ins Feld: +ux,+uy
      markE7v7End(OL,OR,{x:-ux,y:-uy},"(KF) oben",out);  // ins Feld: -ux,-uy
    }

    lastResult=out; return;
  }

  /* --- Großfeld (ohne Detailänderungen) --- */
  // Außen
  addLine(UL,UR,"Grundlinie unten",out);
  addLine(UR,OR,"Seitenlinie rechts",out);
  addLine(OR,OL,"Grundlinie oben",out);
  addLine(OL,UL,"Seitenlinie links",out);
  addPt(UL,"Eckfahne unten links",out);
  addPt(UR,"Eckfahne unten rechts",out);
  addPt(OL,"Eckfahne oben links",out);
  addPt(OR,"Eckfahne oben rechts",out);

  // Mitte
  const mu=mid(UL,UR), mo=mid(OL,OR);
  const mlGF=mid(UL,OL), mrGF=mid(UR,OR);
  const midlineCenterGF={x:(mlGF.x+mrGF.x)/2, y:(mlGF.y+mrGF.y)/2};
  addLine(mlGF,mrGF,"Mittellinie",out);
  addPt(midlineCenterGF,"Mittellinie Mittelpunkt",out);
  const center=mid(mu,mo);
  addPoly(circle(center,9.15,96),"Mittelkreis",out);

  // Schnittpunkte Mittellinie ↔ Seitenlinien
  const spR=lineIntersection(UR,OR,mlGF,mrGF);
  const spL=lineIntersection(UL,OL,mlGF,mrGF);
  if(spR) addPt(spR,"Schnittpunkt Mittellinie & Seitenlinie rechts",out);
  if(spL) addPt(spL,"Schnittpunkt Mittellinie & Seitenlinie links",out);

  // Torbereiche (Großfeld)
  drawTorbereich(mu,ux,uy,nx,ny,"unten",out);
  drawTorbereich(mo,-ux,-uy,nx,ny,"oben",out);

  lastResult=out;
}

/* ---- Buttons ---- */
document.getElementById('reset').onclick=()=>{
  draw.clearLayers();handles.clearLayers();clicks.clearLayers();
  p1=p2=null;lastResult=null;lengthInput.value="";lengthInput.disabled=false;widthInput.disabled=false;
};
document.getElementById('geojson').onclick=exportBothGeoJSON;

/* ---- Export: Punkte & Linien getrennt, Dateiname frei wählbar ---- */
function exportBothGeoJSON(){
  if(!lastResult){alert("Kein Feld erzeugt.");return;}
  const pt=(x,y)=>{const g=toLL(x,y);return[g.lon,g.lat]};
  const base=(fnameInput.value||"X-Platz_SVU").trim().replace(/[\\/:*?"<>|]+/g,"_");
  const ts=new Date().toISOString().replace(/[:.]/g,"-");

  // Punkte
  const fcPts={type:"FeatureCollection",features:[]};
  for(const p of lastResult.points){
    fcPts.features.push({type:"Feature",properties:{name:p.name,type:"point"},geometry:{type:"Point",coordinates:pt(p.x,p.y)}});
  }
  // Linien
  const fcLines={type:"FeatureCollection",features:[]};
  for(const l of lastResult.lines){
    let coords=[];
    if(l.points && l.points.length>1){ coords=l.points.map(q=>pt(q.x,q.y)); }
    else if(l.p1 && l.p2){ coords=[pt(l.p1.x,l.p1.y), pt(l.p2.x,l.p2.y)]; }
    else { continue; }
    fcLines.features.push({
      type:"Feature",
      properties:{name:l.name,type:"line",length_m:Number(l.len?.toFixed?.(2)||l.len||0)},
      geometry:{type:"LineString",coordinates:coords}
    });
  }

  const save=(obj,filename)=>{
    const blob=new Blob([JSON.stringify(obj,null,2)],{type:"application/geo+json"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); URL.revokeObjectURL(a.href);
  };
  save(fcPts,   `${base}_points_${ts}.geojson`);
  save(fcLines, `${base}_lines_${ts}.geojson`);
}
</script>
</body>
</html>