<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Franks Fußballfeld-Generator</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  html,body,#map{height:100%;margin:0}
  .ctrl{
    position:fixed;top:8px;left:50%;transform:translateX(-50%);
    background:#fff;padding:.35rem .45rem;border-radius:.5rem;
    box-shadow:0 2px 10px rgba(0,0,0,.16);z-index:1000;
    display:flex;gap:.35rem;align-items:center;flex-wrap:wrap;font-size:.84rem
  }
  button,select,input,label{
    padding:.28rem .42rem;border:1px solid #d1d5db;border-radius:.4rem;background:#fff;cursor:pointer;
    font-size:.84rem;line-height:1.1
  }
  label{display:flex;gap:.35rem;align-items:center;border:none;padding:0;background:transparent}
  .primary{background:#0ea5e9;border-color:#0284c7;color:#fff}
  .hint{
    position:fixed;bottom:8px;left:50%;transform:translateX(-50%);
    background:#111827;color:#fff;padding:.28rem .45rem;border-radius:.4rem;z-index:1000;font-size:.8rem;opacity:.9
  }
  input[type=number]{width:5.8rem}
  input[type=text]{width:13rem}
  @media (max-width:480px){ .ctrl{font-size:.8rem} button,select,input{font-size:.8rem} input[type=text]{width:11rem} }
</style>
</head>
<body>
<div id="map"></div>

<div class="ctrl">
  <button id="loc" class="primary">Standort</button>
  <button id="wms">Orthofoto</button>

  <select id="mode" title="Modus">
    <option value="grossfeld" selected>Großfeld</option>
    <option value="verkleinertes_grossfeld">verkleinertes Großfeld</option>
    <option value="kleinfeld">Kleinfeld (separat)</option>
  </select>

  <!-- Kleinfeld-Szenarien (nur für „Kleinfeld (separat)“) -->
  <select id="kfScenario" title="Kleinfeld-Szenario" disabled>
    <option value="">Szenario wählen…</option>
    <option value="g2v2_16x20">G-Jugend 2v2 – 16×20 m (Mittellinie, 4 Minitore)</option>
    <option value="g3v3_25x20">G-Jugend 3v3 – 25×20 m (Schusszonen, 4 Minitore)</option>
    <option value="f3v3_25x20">F-Jugend 3v3 – 25×20 m (Schusszonen, 4 Minitore)</option>
    <option value="f5v5_40x25_mini">F 5v5 – 40×25 m (4 Minitore, 6m-Zonen)</option>
    <option value="f5v5_40x25_kf">F 5v5 – 40×25 m (2 Kleinfeldtore, Mittellinie)</option>
    <option value="e5v5_40x25_mini">E 5v5 – 40×25 m (4 Minitore, 6m-Zonen)</option>
    <option value="e5v5_40x25_kf">E 5v5 – 40×25 m (2 Kleinfeldtore, Mittellinie)</option>
    <option value="e7v7_55x35">E 7v7 – 55×35 m (Mittellinie, 5-m-Tore + Strafraum)</option>
  </select>

  <!-- Großfeld: freie Eingabe innerhalb Range -->
  <label>L (m): <input id="length" type="number" step="1" min="90" max="120" placeholder="90–120" value="105"></label>
  <label>B (m): <input id="width"  type="number" step="0.1" min="45" max="90"  placeholder="45–90" value="65"></label>

  <label>Filename: <input id="fname" type="text" value="X-Platz_SVU"></label>
  <button id="reset">Neu</button>
  <button id="geojson">Export</button>
</div>

<div class="hint">Zwei Punkte der rechten Längsseite: 1 = Start (unten rechts), 2 = Richtung (oben rechts).</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/proj4@2.10.0/dist/proj4.js"></script>
<script>
/* ---- EPSG:25832 ---- */
proj4.defs("EPSG:25832","+proj=utm +zone=32 +datum=WGS84 +units=m +no_defs +type=crs");
const toUTM=(lat,lon)=>{const r=proj4("WGS84","EPSG:25832",[lon,lat]);return{x:r[0],y:r[1]}};
const toLL =(x,y)=>{const r=proj4("EPSG:25832","WGS84",[x,y]);return{lat:r[1],lon:r[0]}};

/* ---- Karte ---- */
const map=L.map('map').setView([48.1372,11.5756],18);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20,attribution:'© OpenStreetMap-Mitwirkende'}).addTo(map);

let dop=null;
document.getElementById('wms').onclick=()=>{
  const btn=document.getElementById('wms');
  if(dop){map.removeLayer(dop);dop=null;btn.textContent="Orthofoto";return;}
  dop=L.tileLayer.wms('https://geoservices.bayern.de/od/wms/dop/v1/dop20?',{
    layers:'by_dop20c',version:'1.1.1',format:'image/png',transparent:true,uppercase:true,tileSize:256,
    attribution:'© LDBV DOP20 (WMS) CC BY 4.0'
  }).addTo(map);
  let err=0; dop.on('tileerror',()=>{ if(++err===3){ map.removeLayer(dop); dop=null; alert('Orthofoto WMS nicht erreichbar/Zoom zu hoch – bleibe bei OSM.'); btn.textContent="Orthofoto"; }});
  btn.textContent="Orthofoto aus";
};

/* ---- Standort ---- */
document.getElementById('loc').onclick=()=>{
  if(!navigator.geolocation){alert('Geolocation nicht verfügbar');return;}
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude,longitude,accuracy}=pos.coords;
    const z=accuracy<10?20:accuracy<25?19:18;
    map.setView([latitude,longitude],z);
    L.circle([latitude,longitude],{radius:accuracy}).addTo(draw);
  },()=>alert('Standort nicht möglich. Bitte HTTPS + Erlaubnis prüfen.'),{enableHighAccuracy:true,timeout:10000,maximumAge:0});
};

/* ---- Zeichenlayer ---- */
const draw=L.featureGroup().addTo(map);
const handles=L.featureGroup().addTo(map);
const clicks=L.featureGroup().addTo(map);
let p1=null,p2=null,lastResult=null;

/* ---- UI-Refs ---- */
const widthInput=document.getElementById('width');
const modeSel=document.getElementById('mode');
const fnameInput=document.getElementById('fname');
const lengthInput=document.getElementById('length');
const kfScenario=document.getElementById('kfScenario');

/* ---- Validierung Großfeld (nur bei Zeichnen) ---- */
function validateGrossfeldInputs(){
  if(modeSel.value!=='grossfeld' && modeSel.value!=='verkleinertes_grossfeld') return;
  let L = parseFloat(lengthInput.value);
  let W = parseFloat(widthInput.value);
  if (!Number.isFinite(L)) L = 105;
  if (!Number.isFinite(W)) W = 65;
  if (L < 90) L = 90;
  if (L > 120) L = 120;
  if (W < 45) W = 45;
  if (W > 90)  W = 90;
  lengthInput.value = String(Math.round(L));
  widthInput.value  = String(Math.round(W*10)/10);
}

modeSel.addEventListener('change',()=>{
  const isKF = modeSel.value==='kleinfeld';
  kfScenario.disabled = !isKF;
  if(!isKF){
    if(!lengthInput.value) lengthInput.value='105';
    if(!widthInput.value)  widthInput.value='65';
  }
  if (p1&&p2) recompute();
});
kfScenario.addEventListener('change',()=>{ if (p1&&p2) recompute(); });

/* ---- Helpers ---- */
const norm=(dx,dy)=>{const L=Math.hypot(dx,dy)||1;return{ux:dx/L,uy:dy/L,L}};
const mid =(A,B)=>({x:(A.x+B.x)/2,y:(A.y+B.y)/2});
const toLLArr=ps=>ps.map(p=>{const g=toLL(p.x,p.y);return[g.lat,g.lon]});
function addLine(pA,pB,name,out){const gA=toLL(pA.x,pA.y),gB=toLL(pB.x,pB.y);L.polyline([[gA.lat,gA.lon],[gB.lat,gB.lon]]).addTo(draw).bindTooltip(name);out.lines.push({name,len:Math.hypot(pB.x-pA.x,pB.y-pA.y),p1:pA,p2:pB});}
function addPt(p,name,out){const g=toLL(p.x,p.y);L.circleMarker([g.lat,g.lon],{radius:4}).addTo(draw).bindTooltip(name);out.points.push({name,x:p.x,y:p.y});}
function addPoly(points,name,out){L.polyline(toLLArr(points)).addTo(draw).bindTooltip(name);let len=0;for(let i=1;i<points.length;i++){const a=points[i-1],b=points[i];len+=Math.hypot(b.x-a.x,b.y-a.y);}out.lines.push({name,len,points});}
function circle(c,r,seg=96){const pts=[];for(let i=0;i<=seg;i++){const a=2*Math.PI*i/seg;pts.push({x:c.x+r*Math.cos(a),y:c.y+r*Math.sin(a)});}return pts;}
function lineIntersection(a1,a2,b1,b2){
  const x1=a1.x,y1=a1.y,x2=a2.x,y2=a2.y,x3=b1.x,y3=b1.y,x4=b2.x,y4=b2.y;
  const den=(x1-x2)*(y3-y4)-(y1-y2)*(x3-x4); if(Math.abs(den)<1e-9)return null;
  const px=((x1*y2-y1*x2)*(x3-x4)-(x1-x2)*(x3*y4-y3*x4))/den;
  const py=((x1*y2-y1*x2)*(y3-y4)-(y1-y2)*(x3*y4-y3*x4))/den;
  return {x:px,y:py};
}

/* ---- Großfeld: vollständige Markierungen ---- */
function drawTorbereich(mitte,ux,uy,nx,ny,prefix,out){
  const torHalb=7.32/2;
  const tor_r={x:mitte.x+nx*torHalb,y:mitte.y+ny*torHalb};
  const tor_l={x:mitte.x-nx*torHalb,y:mitte.y-ny*torHalb};
  addPt(mitte,`Torlinienmittelpunkt ${prefix}`,out);
  addPt(tor_r,`Torpfosten ${prefix} rechts`,out);
  addPt(tor_l,`Torpfosten ${prefix} links`,out);
  addLine(tor_r,tor_l,`Torlinie ${prefix}`,out);

  // 5-m-Raum
  const f5r={x:tor_r.x+nx*5.5,y:tor_r.y+ny*5.5};
  const f5l={x:tor_l.x-nx*5.5,y:tor_l.y-ny*5.5};
  addPt(f5r,`5m Fusspunkt ${prefix} rechts`,out);
  addPt(f5l,`5m Fusspunkt ${prefix} links`,out);
  const e5r={x:f5r.x+ux*5.5,y:f5r.y+uy*5.5};
  const e5l={x:f5l.x+ux*5.5,y:f5l.y+uy*5.5};
  addLine(f5r,e5r,`5m Linie ${prefix} rechts`,out);
  addLine(f5l,e5l,`5m Linie ${prefix} links`,out);
  addLine(e5r,e5l,`5m Parallel ${prefix}`,out);

  // 16,5-m-Raum
  const f16r={x:tor_r.x+nx*16.5,y:tor_r.y+ny*16.5};
  const f16l={x:tor_l.x-nx*16.5,y:tor_l.y-ny*16.5};
  addPt(f16r,`16,5m Fusspunkt ${prefix} rechts`,out);
  addPt(f16l,`16,5m Fusspunkt ${prefix} links`,out);
  const e16r={x:f16r.x+ux*16.5,y:f16r.y+uy*16.5};
  const e16l={x:f16l.x+ux*16.5,y:f16l.y+uy*16.5};
  addPt(e16r,`16,5m Eckpunkt ${prefix} rechts`,out);
  addPt(e16l,`16,5m Eckpunkt ${prefix} links`,out);
  addLine(f16r,e16r,`16,5m Linie ${prefix} rechts`,out);
  addLine(f16l,e16l,`16,5m Linie ${prefix} links`,out);
  addLine(e16r,e16l,`16,5m Parallel ${prefix}`,out);

  const elfer={x:mitte.x+ux*11,y:mitte.y+uy*11};
  addPt(elfer,`Elfmeterpunkt ${prefix}`,out);
}

/* ---- Kleinfeld: Mini-Tore (2 m) an den Grundlinien ---- */
function drawMiniGoalsOnEnd(endLeft, endRight, namePrefix, out){
  const ex=endRight.x-endLeft.x, ey=endRight.y-endLeft.y;
  const elen=Math.hypot(ex,ey)||1, vx=ex/elen, vy=ey/elen;
  const L_ref={x:endLeft.x+vx*2, y:endLeft.y+vy*2};
  const L_other={x:L_ref.x+vx*2, y:L_ref.y+vy*2};
  addPt(L_ref,`${namePrefix} Minitor-Pfosten (links, 2m)`,out);
  addLine(L_ref,L_other,`${namePrefix} Minitor (links, 2m)`,out);
  const R_ref={x:endRight.x-vx*2, y:endRight.y-vy*2};
  const R_other={x:R_ref.x-vx*2, y:R_ref.y-vy*2};
  addPt(R_ref,`${namePrefix} Minitor-Pfosten (rechts, 2m)`,out);
  addLine(R_ref,R_other,`${namePrefix} Minitor (rechts, 2m)`,out);
}

/* ---- Kleinfeld: 5-m-Kleinfeldtor ---- */
function drawKleinfeldGoalOnEnd(endLeft, endRight, namePrefix, out){
  const ex=endRight.x-endLeft.x, ey=endRight.y-endLeft.y;
  const elen=Math.hypot(ex,ey)||1, vx=ex/elen, vy=ey/elen;
  const mid={x:(endLeft.x+endRight.x)/2, y:(endLeft.y+endRight.y)/2};
  addPt(mid,`${namePrefix} Tor-Mittelpunkt`,out);
  const pR={x:mid.x+vx*2.5, y:mid.y+vy*2.5};
  const pL={x:mid.x-vx*2.5, y:mid.y-vy*2.5};
  addPt(pR,`${namePrefix} Torpfosten rechts (±2.5m)`,out);
  addPt(pL,`${namePrefix} Torpfosten links (±2.5m)`,out);
  addLine(pL,pR,`${namePrefix} Torlinie (5m)`,out);
}

/* ---- E 7v7: Strafraum inkl. Linien ---- */
function markE7v7End(endLeft, endRight, intoFieldDir, namePrefix, out){
  const ex=endRight.x-endLeft.x, ey=endRight.y-endLeft.y;
  const elen=Math.hypot(ex,ey)||1, vx=ex/elen, vy=ey/elen;
  const mid={x:(endLeft.x+endRight.x)/2, y:(endLeft.y+endRight.y)/2};
  addPt(mid,`${namePrefix} Tor-Mittelpunkt`,out);
  const pR={x:mid.x+vx*2.5, y:mid.y+vy*2.5};
  const pL={x:mid.x-vx*2.5, y:mid.y-vy*2.5};
  addPt(pR,`${namePrefix} Torpfosten rechts (±2.5m)`,out);
  addPt(pL,`${namePrefix} Torpfosten links (±2.5m)`,out);
  addLine(pL,pR,`${namePrefix} Torlinie (5m)`,out);
  const fL={x:pL.x - vx*12, y:pL.y - vy*12};
  const fR={x:pR.x + vx*12, y:pR.y + vy*12};
  addPt(fL,`${namePrefix} Fusspunkt Strafraum links (+12m)`,out);
  addPt(fR,`${namePrefix} Fusspunkt Strafraum rechts (+12m)`,out);
  const ix=intoFieldDir.x, iy=intoFieldDir.y;
  const cL={x:fL.x + ix*12, y:fL.y + iy*12};
  const cR={x:fR.x + ix*12, y:fR.y + iy*12};
  addPt(cL,`${namePrefix} Ecke Strafraum links (12m orth.)`,out);
  addPt(cR,`${namePrefix} Ecke Strafraum rechts (12m orth.)`,out);
  const sp={x:mid.x + ix*8, y:mid.y + iy*8};
  addPt(sp,`${namePrefix} Strafstoßpunkt (8m)`,out);
  addLine(fL, cL, `${namePrefix} Strafraum Linie links`, out);
  addLine(fR, cR, `${namePrefix} Strafraum Linie rechts`, out);
  addLine(cL, cR, `${namePrefix} Strafraum Vorderkante`, out);
}

/* ---- Kleinfeld: Schusszonen 6 m (liefert Segmente) ---- */
function drawSchusszonen(UL,UR,OL,OR, ux,uy, namePrefix, out){
  const bottomA={x:UL.x+ux*6, y:UL.y+uy*6};
  const bottomB={x:UR.x+ux*6, y:UR.y+uy*6};
  const topA   ={x:OL.x-ux*6, y:OL.y-uy*6};
  const topB   ={x:OR.x-ux*6, y:OR.y-uy*6};
  addLine(bottomA,bottomB,`${namePrefix} Schusszone unten (6m)`,out);
  addLine(topA,topB,      `${namePrefix} Schusszone oben (6m)`,out);
  return {bottomA,bottomB,topA,topB};
}

/* ---- Verkleinertes Großfeld ---- */
function drawReducedField(UL,UR,OL,OR, ux,uy,nx,ny,out){
  // Torlinien (auf Höhe 16,5 m der Großfeld-Strafraumlinien)
  const bL={x:UL.x+ux*16.5, y:UL.y+uy*16.5};
  const bR={x:UR.x+ux*16.5, y:UR.y+uy*16.5};
  const tL={x:OL.x-ux*16.5, y:OL.y-uy*16.5};
  const tR={x:OR.x-ux*16.5, y:OR.y-uy*16.5};
  addLine(bL,bR,"(vGF) Torlinie unten (16,5 m)",out);
  addLine(tL,tR,"(vGF) Torlinie oben (16,5 m)",out);

  // Mittelpunkte Torlinien
  const mB={x:(bL.x+bR.x)/2, y:(bL.y+bR.y)/2};
  const mT={x:(tL.x+tR.x)/2, y:(tL.y+tR.y)/2};
  addPt(mB,"(vGF) Tor-Mittelpunkt unten",out);
  addPt(mT,"(vGF) Tor-Mittelpunkt oben",out);

  // Pfosten (5 m Tor): ±2,5 m entlang Torlinie (nx,ny)
  const pBR={x:mB.x+nx*2.5, y:mB.y+ny*2.5};
  const pBL={x:mB.x-nx*2.5, y:mB.y-ny*2.5};
  const pTR={x:mT.x+nx*2.5, y:mT.y+ny*2.5};
  const pTL={x:mT.x-nx*2.5, y:mT.y-ny*2.5};
  addPt(pBR,"(vGF) Pfosten unten rechts",out);
  addPt(pBL,"(vGF) Pfosten unten links",out);
  addPt(pTR,"(vGF) Pfosten oben rechts",out);
  addPt(pTL,"(vGF) Pfosten oben links",out);
  addLine(pBL,pBR,"(vGF) Torlinie unten (5 m)",out);
  addLine(pTL,pTR,"(vGF) Torlinie oben (5 m)",out);

  // Strafraum-Fußpunkte: ±14,5 m (2,5 + 12) auf der Torlinie
  const sFB_R={x:mB.x+nx*14.5, y:mB.y+ny*14.5};
  const sFB_L={x:mB.x-nx*14.5, y:mB.y-ny*14.5};
  const sFT_R={x:mT.x+nx*14.5, y:mT.y+ny*14.5};
  const sFT_L={x:mT.x-nx*14.5, y:mT.y-ny*14.5};
  addPt(sFB_R,"(vGF) Strafraum-Fusspunkt unten rechts (±14,5 m)",out);
  addPt(sFB_L,"(vGF) Strafraum-Fusspunkt unten links (±14,5 m)",out);
  addPt(sFT_R,"(vGF) Strafraum-Fusspunkt oben rechts (±14,5 m)",out);
  addPt(sFT_L,"(vGF) Strafraum-Fusspunkt oben links (±14,5 m)",out);

  // Von den Fußpunkten 12 m orthogonal (parallel zur Seitenlinie = entlang ux,uy)
  const cB_R={x:sFB_R.x+ux*12, y:sFB_R.y+uy*12};
  const cB_L={x:sFB_L.x+ux*12, y:sFB_L.y+uy*12};
  const cT_R={x:sFT_R.x-ux*12, y:sFT_R.y-uy*12};
  const cT_L={x:sFT_L.x-ux*12, y:sFT_L.y-uy*12};
  addLine(sFB_R,cB_R,"(vGF) Strafraumgrenze unten rechts (12 m)",out);
  addLine(sFB_L,cB_L,"(vGF) Strafraumgrenze unten links (12 m)",out);
  addLine(sFT_R,cT_R,"(vGF) Strafraumgrenze oben rechts (12 m)",out);
  addLine(sFT_L,cT_L,"(vGF) Strafraumgrenze oben links (12 m)",out);

  // Frontlinie des Strafraums (parallel zur Torlinie)
  addLine(cB_L,cB_R,"(vGF) Strafraum-Front unten",out);
  addLine(cT_L,cT_R,"(vGF) Strafraum-Front oben",out);

  // Seitenlinien-Position: ±24,5 m (14,5 + 10) auf der Torlinie
  const sB_R={x:mB.x+nx*24.5, y:mB.y+ny*24.5};
  const sB_L={x:mB.x-nx*24.5, y:mB.y-ny*24.5};
  const sT_R={x:mT.x+nx*24.5, y:mT.y+ny*24.5};
  const sT_L={x:mT.x-nx*24.5, y:mT.y-ny*24.5};

  // Seitenlinien (senkrecht zur Torlinie: entlang ux,uy), verbinden unten↔oben
  addLine(sB_L,sT_L,"(vGF) Seitenlinie links",out);
  addLine(sB_R,sT_R,"(vGF) Seitenlinie rechts",out);

  // Mittellinie (mittig zwischen Torlinien, parallel zur Torlinie), Anstoßpunkt
  const midLeft ={x:(sB_L.x+sT_L.x)/2, y:(sB_L.y+sT_L.y)/2};
  const midRight={x:(sB_R.x+sT_R.x)/2, y:(sB_R.y+sT_R.y)/2};
  addLine(midLeft,midRight,"(vGF) Mittellinie",out);
  const kickoff={x:(midLeft.x+midRight.x)/2, y:(midLeft.y+midRight.y)/2};
  addPt(kickoff,"(vGF) Anstoßpunkt",out);

  // Strafstoßpunkte 9 m von der Torlinie ins Feld (entlang ux,uy)
  const penB={x:mB.x+ux*9, y:mB.y+uy*9};
  const penT={x:mT.x-ux*9, y:mT.y-uy*9};
  addPt(penB,"(vGF) Strafstoßpunkt unten (9 m)",out);
  addPt(penT,"(vGF) Strafstoßpunkt oben  (9 m)",out);
}

/* ---- Kleinfeld (separat) mit Schnittpunkt-Punkten ---- */
function applyScenarioDimensions(){
  const v=kfScenario.value;
  let L=null,W=null;
  if(v==='g2v2_16x20'){ L=16; W=20; }
  else if(v==='g3v3_25x20' || v==='f3v3_25x20'){ L=25; W=20; }
  else if(v==='f5v5_40x25_mini' || v==='f5v5_40x25_kf' || v==='e5v5_40x25_mini' || v==='e5v5_40x25_kf'){ L=40; W=25; }
  else if(v==='e7v7_55x35'){ L=55; W=35; }
  if(L&&W){ lengthInput.value=String(L); widthInput.value =String(W); }
}
function drawKleinfeldSeparate(UR,OR,UL,OL, ux,uy,nx,ny,out){
  const s=kfScenario.value;
  // Außen
  addLine(UL,UR,"(KF) Grundlinie unten",out);
  addLine(UR,OR,"(KF) Seitenlinie rechts",out);
  addLine(OR,OL,"(KF) Grundlinie oben",out);
  addLine(OL,UL,"(KF) Seitenlinie links",out);
  addPt(UL,"(KF) Eckpunkt unten links",out);
  addPt(UR,"(KF) Eckpunkt unten rechts",out);
  addPt(OL,"(KF) Eckpunkt oben links",out);
  addPt(OR,"(KF) Eckpunkt oben rechts",out);

  const sideRight={A:UR,B:OR};
  const sideLeft ={A:UL,B:OL};

  // Mittellinie (wo gefordert) + Mittelpunkt + Schnittpunkte mit Seitenlinien
  const ml=mid(UL,OL), mr=mid(UR,OR);
  const midCenter={x:(ml.x+mr.x)/2, y:(ml.y+mr.y)/2};
  const needMid = (s==='g2v2_16x20' || s==='e5v5_40x25_kf' || s==='f5v5_40x25_kf' || s==='e7v7_55x35');
  if(needMid){
    addLine(ml,mr,"(KF) Mittellinie",out);
    addPt(midCenter,"(KF) Mittellinie Mittelpunkt",out);
    const spR=lineIntersection(sideRight.A,sideRight.B,ml,mr);
    const spL=lineIntersection(sideLeft.A, sideLeft.B, ml,mr);
    if(spR) addPt(spR,"(KF) Schnittpunkt Mittellinie & Seitenlinie rechts",out);
    if(spL) addPt(spL,"(KF) Schnittpunkt Mittellinie & Seitenlinie links",out);
  }

  // Schusszonen (6 m) + Schnittpunkte
  const needZones = (s==='g3v3_25x20' || s==='f3v3_25x20' || s==='e5v5_40x25_mini' || s==='f5v5_40x25_mini');
  if(needZones){
    const zones=drawSchusszonen(UL,UR,OL,OR, ux,uy, "(KF)", out);
    const izR=lineIntersection(sideRight.A,sideRight.B, zones.bottomA, zones.bottomB);
    const izL=lineIntersection(sideLeft.A, sideLeft.B,  zones.bottomA, zones.bottomB);
    const ozR=lineIntersection(sideRight.A,sideRight.B, zones.topA, zones.topB);
    const ozL=lineIntersection(sideLeft.A, sideLeft.B,  zones.topA, zones.topB);
    if(izR) addPt(izR,"(KF) Schnittpunkt rechts & Schusszone unten",out);
    if(izL) addPt(izL,"(KF) Schnittpunkt links  & Schusszone unten",out);
    if(ozR) addPt(ozR,"(KF) Schnittpunkt rechts & Schusszone oben",out);
    if(ozL) addPt(ozL,"(KF) Schnittpunkt links  & Schusszone oben",out);
  }

  // Tore / Markierungen
  if(s==='g2v2_16x20' || s==='g3v3_25x20' || s==='f3v3_25x20' || s==='e5v5_40x25_mini' || s==='f5v5_40x25_mini'){
    drawMiniGoalsOnEnd(UL,UR,"(KF) unten",out);
    drawMiniGoalsOnEnd(OL,OR,"(KF) oben",out);
  } else if(s==='e5v5_40x25_kf' || s==='f5v5_40x25_kf'){
    drawKleinfeldGoalOnEnd(UL,UR,"(KF) unten",out);
    drawKleinfeldGoalOnEnd(OL,OR,"(KF) oben",out);
  } else if(s==='e7v7_55x35'){
    // E 7v7: inkl. Strafraum
    const intoB={x:ux,y:uy}, intoT={x:-ux,y:-uy};
    markE7v7End(UL,UR,intoB,"(KF) unten",out);
    markE7v7End(OL,OR,intoT,"(KF) oben",out);
  }
}

/* ---- Klick-Logik ---- */
map.on('click',e=>{
  if(handles.getLayers().length===2) return;
  clicks.addLayer(L.circleMarker(e.latlng,{radius:5}));
  if(!p1){ p1=e.latlng; }
  else{
    p2=e.latlng; makeHandles();
    recompute();
  }
});
function makeHandles(){
  handles.clearLayers();
  const m1=L.marker(p1,{draggable:true,title:"Punkt 1 (Start, unten rechts)"}).addTo(handles);
  const m2=L.marker(p2,{draggable:true,title:"Punkt 2 (Richtung, oben rechts)"}).addTo(handles);
  m1.on('drag',()=>{p1=m1.getLatLng();recompute()});
  m2.on('drag',()=>{p2=m2.getLatLng();recompute()});
}

/* ---- Zeichnen ---- */
function recompute(){
  if(!p1||!p2) return;
  draw.clearLayers();

  validateGrossfeldInputs();

  const P1=toUTM(p1.lat,p1.lng), P2=toUTM(p2.lat,p2.lng);
  const {ux,uy}=norm(P2.x-P1.x,P2.y-P1.y);
  const nx=-uy, ny=ux;

  const len=Math.round(parseFloat(lengthInput.value||"105"));
  const W=parseFloat(widthInput.value||"65");
  const mode=modeSel.value;

  // Außenrechteck auf Basis der Seitenlinie
  const UR={x:P1.x,y:P1.y};                         // unten rechts (Start)
  const OR={x:P1.x+ux*len,y:P1.y+uy*len};           // oben rechts
  const OL={x:OR.x+nx*W,y:OR.y+ny*W};
  const UL={x:UR.x+nx*W,y:UR.y+ny*W};

  const out={points:[],lines:[]};

  /* --- Kleinfeld separat? Dann ausschließlich dieses zeichnen --- */
  if(mode==='kleinfeld' && kfScenario.value){
    // Dimensionen aus Preset übernehmen
    const L0 = parseFloat(lengthInput.value), W0 = parseFloat(widthInput.value);
    if(!Number.isFinite(L0) || !Number.isFinite(W0)) applyScenarioDimensions();

    // Außen (UL..OR) ist bereits passend; zeichnen und Szenario-Details
    drawKleinfeldSeparate(UR,OR,UL,OL, ux,uy,nx,ny,out);
    lastResult=out; return;
  }

  /* --- Großfeld (immer zeichnen in den Großfeld-Modi) --- */
  addLine(UL,UR,"Grundlinie unten",out);
  addLine(UR,OR,"Seitenlinie rechts",out);
  addLine(OR,OL,"Grundlinie oben",out);
  addLine(OL,UL,"Seitenlinie links",out);
  addPt(UL,"Eckfahne unten links",out);
  addPt(UR,"Eckfahne unten rechts",out);
  addPt(OL,"Eckfahne oben links",out);
  addPt(OR,"Eckfahne oben rechts",out);

  const mu=mid(UL,UR), mo=mid(OL,OR);
  const mlGF=mid(UL,OL), mrGF=mid(UR,OR);
  const midlineCenterGF={x:(mlGF.x+mrGF.x)/2, y:(mlGF.y+mrGF.y)/2};
  addLine(mlGF,mrGF,"Mittellinie",out);
  addPt(midlineCenterGF,"Mittellinie Mittelpunkt",out);
  const center=mid(mu,mo);
  addPoly(circle(center,9.15,96),"Mittelkreis",out);

  const spR=lineIntersection(UR,OR,mlGF,mrGF);
  const spL=lineIntersection(UL,OL,mlGF,mrGF);
  if(spR) addPt(spR,"Schnittpunkt Mittellinie & Seitenlinie rechts",out);
  if(spL) addPt(spL,"Schnittpunkt Mittellinie & Seitenlinie links",out);

  drawTorbereich(mu,ux,uy,nx,ny,"unten",out);
  drawTorbereich(mo,-ux,-uy,nx,ny,"oben",out);

  /* --- Verkleinertes Großfeld zusätzlich? --- */
  if(mode==='verkleinertes_grossfeld'){
    drawReducedField(UL,UR,OL,OR, ux,uy,nx,ny,out);
  }

  lastResult=out;
}

/* ---- Buttons ---- */
document.getElementById('reset').onclick=()=>{
  draw.clearLayers();handles.clearLayers();clicks.clearLayers();
  p1=p2=null;lastResult=null;
  if(!lengthInput.value) lengthInput.value="105";
  if(!widthInput.value)  widthInput.value="65";
};
document.getElementById('geojson').onclick=exportBothGeoJSON;

/* ---- Export: Punkte & Linien getrennt ---- */
function exportBothGeoJSON(){
  if(!lastResult){alert("Kein Feld erzeugt.");return;}
  const pt=(x,y)=>{const g=toLL(x,y);return[g.lon,g.lat]};
  const base=(fnameInput.value||"X-Platz_SVU").trim().replace(/[\\/:*?"<>|]+/g,"_");
  const ts=new Date().toISOString().replace(/[:.]/g,"-");
  const fcPts={type:"FeatureCollection",features:[]};
  for(const p of lastResult.points){
    fcPts.features.push({type:"Feature",properties:{name:p.name,type:"point"},geometry:{type:"Point",coordinates:pt(p.x,p.y)}});
  }
  const fcLines={type:"FeatureCollection",features:[]};
  for(const l of lastResult.lines){
    let coords=[];
    if(l.points && l.points.length>1){ coords=l.points.map(q=>pt(q.x,q.y)); }
    else if(l.p1 && l.p2){ coords=[pt(l.p1.x,l.p1.y), pt(l.p2.x,l.p2.y)]; }
    else { continue; }
    fcLines.features.push({
      type:"Feature",
      properties:{name:l.name,type:"line",length_m:Number(l.len?.toFixed?.(2)||l.len||0)},
      geometry:{type:"LineString",coordinates:coords}
    });
  }
  const save=(obj,filename)=>{
    const blob=new Blob([JSON.stringify(obj,null,2)],{type:"application/geo+json"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); URL.revokeObjectURL(a.href);
  };
  save(fcPts,   `${base}_points_${ts}.geojson`);
  save(fcLines, `${base}_lines_${ts}.geojson`);
}
</script>
</body>
</html>